# E2E тесты

Интеграционные (E2E) тесты для проверки полного flow работы API через HTTP запросы.

## Два режима работы

### 1. Изолированное окружение (docker-compose.e2e.yaml)

**Рекомендуется для CI/CD и production-like тестирования**

Создает полностью изолированное окружение с отдельной базой данных, API и тестами в контейнерах.

**Архитектура:**
```
┌─────────────────────────────────────┐
│   E2E Test Network (isolated)       │
│                                     │
│  ┌──────────────┐  ┌─────────────┐ │
│  │ postgres-e2e │  │  api-e2e    │ │
│  │  :5432       │  │  :8080      │ │
│  │ testdb       │◄─┤             │ │
│  └──────────────┘  └─────────────┘ │
│         ▲                ▲          │
│         │                │          │
│         │    ┌──────────────┐      │
│         └────┤ e2e-tests    │      │
│              │ (container)  │      │
│              └──────────────┘      │
└─────────────────────────────────────┘
```

**Запуск:**
```bash
# Запуск всех контейнеров и тестов
make test-e2e-isolated

# Поднять только окружение (для отладки)
make test-e2e-up

# Остановить и очистить
make test-e2e-down
```

**Преимущества:**
- ✅ Полная изоляция от production базы данных
- ✅ Отдельная сеть и окружение
- ✅ API на порту 8082, БД на порту 5433
- ✅ Автоматическая очистка после тестов
- ✅ Повторяемость результатов
- ✅ Идеально для CI/CD

**Переменные окружения:**
- `API_BASE_URL`: URL внешнего API (http://api-e2e:8080)
- `TEST_DATABASE_URL`: URL тестовой БД (postgres://testuser:testsecret@postgres-e2e:5432/testdb)

### 2. Локальное тестирование (dockertest)

**Рекомендуется для быстрой разработки и отладки**

Использует `dockertest` для автоматического управления PostgreSQL контейнером, API поднимается in-process.

**Запуск:**
```bash
# Локальный запуск (Docker должен быть запущен)
make test-e2e

# Или напрямую
go test -v ./test/e2e/... -timeout 120s
```

**Преимущества:**
- ✅ Быстрая разработка
- ✅ Простая отладка (можно использовать debugger)
- ✅ Автоматическое управление контейнерами
- ✅ Не требует docker-compose

## Что тестируется

- ✅ Создание пользователей
- ✅ Получение пользователя по ID
- ✅ Создание команд
- ✅ Добавление участников в команды
- ✅ Создание PR с автоматическим назначением ревьюверов
- ✅ Переназначение ревьюверов
- ✅ Merge PR
- ✅ Запрет переназначения после merge
- ✅ Массовая деактивация команды
- ✅ Получение статистики

## Структура тестов

Каждый тест:
1. Настраивает тестовый HTTP сервер с реальной БД
2. Применяет миграции
3. Выполняет тестовые сценарии через HTTP API
4. Очищает тестовые данные после завершения

## Примечания

- Тесты используют реальную PostgreSQL БД (не in-memory)
- После каждого теста данные очищаются
- Тесты изолированы друг от друга
- Таймаут выполнения: 120 секунд

## Изоляция от production

**Важно:** E2E тесты используют отдельную базу данных и не влияют на production окружение.

- **Production БД**: `pr_reviewer` на порту 5432 (docker-compose.yml)
- **Test БД**: `testdb` на порту 5433 (docker-compose.e2e.yaml)
- **Production API**: порт 8081
- **Test API**: порт 8082

Никогда не запускайте E2E тесты против production базы данных!

